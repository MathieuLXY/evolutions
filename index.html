<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Evolutions</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px}
    h1{margin:0 0 8px 0}
    .sub{color:#666;margin:0 0 14px 0;font-size:13px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .tabs{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .tabs button{padding:8px 12px;border:1px solid #ddd;background:#f8f8f8;cursor:pointer;border-radius:8px}
    .tabs button.active{background:#fff;border-color:#999}
    input[type="search"]{padding:8px;width:260px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #eee;padding:6px 8px;font-size:14px;vertical-align:top}
    th{background:#fafafa;text-align:left;position:sticky;top:0}
    .empty{color:#777;padding:16px}
    .tip{color:#555;font-size:12px;margin-top:8px}
    .btn{padding:8px 12px;border:1px solid #ddd;background:#f8f8f8;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
<h1>Evolutions</h1>
<p class="sub">Tableau lecture seule. Charge ton fichier JSON de données pour afficher les onglets.</p>

<div class="tabs" id="tabs"></div>

<div class="bar">
  <input id="q" type="search" placeholder="Filtrer (texte)">
  <button class="btn" id="load">Charger JSON…</button>
  <button class="btn" id="save">Exporter JSON</button>
  <span id="stamp" class="tip"></span>
</div>

<div id="table"></div>

<script>
const DATA = { Speculation: [], Sport: [], Mental_Physique: [], Objectifs: [], Evolution: [] };

const TABS = ["Speculation","Sport","Mental_Physique","Objectifs","Evolution"];
let current = "Sport";

const tabs = document.getElementById('tabs');
const tableDiv = document.getElementById('table');
const q = document.getElementById('q');
const stamp = document.getElementById('stamp');

TABS.forEach(t=>{
  const b = document.createElement('button');
  b.textContent = t; b.className = 'btn';
  b.onclick = ()=>{document.querySelectorAll('.tabs button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); current=t; render();};
  if(t===current) b.classList.add('active');
  tabs.appendChild(b);
});

q.addEventListener('input', render);

function ensureComputed(){
  (DATA.Speculation || []).forEach(r => {
    const prix = parseFloat(r.Achat_Prix || 0);
    const frais = parseFloat(r.Achat_Frais || 0);
    const total = (isNaN(prix)?0:prix) + (isNaN(frais)?0:frais);
    if (total && (r.Achat_Total === undefined || r.Achat_Total === "")) {
      r.Achat_Total = Math.round(total * 100) / 100;
    }
  });
}

function render(){
  ensureComputed();
  const rows = DATA[current] || [];
  const term = q.value?.trim().toLowerCase() || "";
  const filtered = term ? rows.filter(r => JSON.stringify(r).toLowerCase().includes(term)) : rows;
  if(filtered.length===0){ tableDiv.innerHTML = `<div class="empty">Aucune donnée.</div>`; stamp.textContent=""; return; }
  const cols = Object.keys(filtered[0]);
  let html = "<table><thead><tr>" + cols.map(c=>`<th>${c}</th>`).join("") + "</tr></thead><tbody>";
  html += filtered.map(r=>"<tr>"+cols.map(c=>`<td>${r[c] ?? ""}</td>`).join("")+"</tr>").join("");
  html += "</tbody></table>";
  tableDiv.innerHTML = html;
  stamp.textContent = "Dernière mise à jour : " + new Date().toLocaleString();
}
render();

// Load JSON (structure: {Speculation:[...], Sport:[...], ...})
document.getElementById('load').addEventListener('click', ()=>{
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.json,application/json';
  inp.onchange = () => {
    const f = inp.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        const TABS = ["Speculation","Sport","Mental_Physique","Objectifs","Evolution"];
        for(const k of TABS){ if(parsed[k]) DATA[k] = parsed[k]; }
        render();
        alert("Données chargées.");
      }catch(e){ alert("JSON invalide : " + e.message); }
    };
    reader.readAsText(f, 'utf-8');
  };
  inp.click();
});

document.getElementById('save').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(DATA, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ledger_data.json';
  a.click();
});
</script>
</body>
</html>